<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WHO/WHICH Relative Clauses Test</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    .option-correct { background-color: #d1fae5 !important; border-color: #10b981 !important; }
    .option-incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
    .progress-bar { height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background-color: #3b82f6; transition: width 0.25s ease; }

    .fade-in { animation: fadeIn 400ms ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    .ready-bar { height: 10px; border-radius: 999px; background: rgba(255,255,255,0.25); overflow: hidden; }
    .ready-fill { height: 100%; width: 0%; background: rgba(255,255,255,0.9); transition: width 3.2s linear; }

    /* Confetti */
    .confetti-wrap { position: relative; overflow: hidden; }
    .confetti {
      position: absolute;
      top: -12px;
      width: 10px;
      height: 14px;
      opacity: 0.9;
      transform: rotate(0deg);
      animation: confettiFall 2.8s ease-in forwards;
      border-radius: 3px;
      filter: drop-shadow(0 6px 6px rgba(0,0,0,.08));
    }
    @keyframes confettiFall {
      0%   { transform: translateY(-20px) rotate(0deg); opacity: 0; }
      10%  { opacity: 1; }
      100% { transform: translateY(420px) rotate(540deg); opacity: 0; }
    }

    .badge-pop { animation: badgePop 650ms cubic-bezier(.2,1.2,.2,1) forwards; }
    @keyframes badgePop {
      0% { transform: scale(.86); opacity: .0; }
      55% { transform: scale(1.06); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col items-center justify-center min-h-screen p-4">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-6">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 class="text-2xl font-bold">WHO/WHICH Relative Clauses Test</h1>
          <div class="flex items-center mt-2 opacity-95">
            <i class="fas fa-graduation-cap mr-2"></i>
            <span id="subtitle">English Grammar Assessment</span>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3 justify-end" id="stats-bar">
          <div class="text-center bg-blue-800 bg-opacity-30 px-4 py-2 rounded-lg">
            <div class="text-sm">Score</div>
            <div class="text-xl font-bold" id="score">0/20</div>
          </div>

          <div class="text-center bg-blue-800 bg-opacity-30 px-4 py-2 rounded-lg">
            <div class="text-sm">Progress</div>
            <div class="text-xl font-bold" id="progress">1/20</div>
          </div>

          <div class="text-center bg-blue-800 bg-opacity-30 px-4 py-2 rounded-lg">
            <div class="text-sm">Time</div>
            <div class="text-xl font-bold" id="timer">--</div>
          </div>

          <div class="text-center bg-blue-800 bg-opacity-30 px-4 py-2 rounded-lg">
            <div class="text-sm">Violations</div>
            <div class="text-xl font-bold" id="violations">0</div>
          </div>
        </div>
      </div>

      <div class="mt-4" id="progress-wrap">
        <div class="flex justify-between text-sm mb-1">
          <span>Question <span id="current-question-num">1</span> of 20</span>
          <span id="progress-percent">5%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 5%"></div>
        </div>
      </div>
    </div>

    <!-- Body -->
    <div class="p-6">
      <div id="question-container" class="mb-6"></div>
      <div id="feedback" class="mt-6 p-4 rounded-lg border hidden"></div>

      <div class="flex flex-col sm:flex-row justify-between mt-8 gap-4" id="nav-buttons">
        <button id="prev-btn"
          class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-5 py-3 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
          disabled>
          <i class="fas fa-arrow-left mr-2"></i> Previous
        </button>

        <button id="next-btn"
          class="bg-blue-500 hover:bg-blue-600 text-white font-medium px-5 py-3 rounded-lg transition duration-200 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
          Next Question <i class="fas fa-arrow-right ml-2"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Violation Overlay -->
  <div id="violationOverlay" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl p-6 fade-in">
      <div class="flex items-start gap-3">
        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center shrink-0">
          <i class="fas fa-triangle-exclamation text-red-600 text-xl"></i>
        </div>
        <div class="flex-1">
          <h3 class="text-xl font-bold text-gray-800">Violation Detected</h3>
          <p class="text-gray-600 mt-1" id="violationReason">You switched the screen.</p>

          <div class="mt-4 bg-red-50 border border-red-200 rounded-xl p-4">
            <div class="flex items-center justify-between">
              <div class="text-sm text-red-700">
                Violations: <span class="font-bold" id="violationCountText">1</span> /
                <span class="font-bold" id="violationMaxText">3</span>
              </div>
              <div class="text-sm text-gray-600" id="violationNote">Please stay on the test page.</div>
            </div>
          </div>

          <button id="violationOkBtn"
            class="mt-5 w-full bg-red-500 hover:bg-red-600 text-white font-semibold px-6 py-3 rounded-xl transition duration-200">
            I Understand
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // CONFIG
    // ----------------------------
    const TIME_PER_QUESTION = 40;
    const MAX_VIOLATIONS = 3;
    const VIOLATION_COOLDOWN_MS = 1500;

    // ----------------------------
    // QUESTIONS
    // ✅ Correct answers are spread across A/B/C (NOT always B).
    // correctIndex: 0=A, 1=B, 2=C
    // ----------------------------
    const questions = [
      // 1: correct = C
      { s1:"I have a neighbour.", s2:"He always helps people carry heavy bags.",
        options:[
          "I have a neighbour which always helps people carry heavy bags.",
          "I have a neighbour who he always helps people carry heavy bags.",
          "I have a neighbour who always helps people carry heavy bags."
        ],
        correctIndex:2, explanation:"Use 'who' for people. Don't repeat the pronoun (NOT: 'who he')."
      },

      // 2: correct = A
      { s1:"I can’t find the message.", s2:"You sent it this morning.",
        options:[
          "I can’t find the message which you sent this morning.",
          "I can’t find the message who you sent this morning.",
          "I can’t find the message which you sent it this morning."
        ],
        correctIndex:0, explanation:"Use 'which' for things. Don’t repeat the object pronoun (NOT: 'sent it')."
      },

      // 3: correct = B
      { s1:"That’s the student.", s2:"She asks the best questions in class.",
        options:[
          "That’s the student who she asks the best questions in class.",
          "That’s the student who asks the best questions in class.",
          "That’s the student which asks the best questions in class."
        ],
        correctIndex:1, explanation:"Use 'who' for people. Don’t repeat the subject (NOT: 'who she')."
      },

      // 4: correct = A
      { s1:"The café is usually full.", s2:"We studied there last week.",
        options:[
          "The café which we studied in last week is usually full.",
          "The café which we studied there last week is usually full.",
          "The café who we studied there last week is usually full."
        ],
        correctIndex:0, explanation:"Use 'which' for things/places. Better: 'the café which we studied in'."
      },

      // 5: correct = C
      { s1:"I spoke to a receptionist.", s2:"She explained everything clearly.",
        options:[
          "I spoke to a receptionist which explained everything clearly.",
          "I spoke to a receptionist who she explained everything clearly.",
          "I spoke to a receptionist who explained everything clearly."
        ],
        correctIndex:2, explanation:"Receptionist = person → 'who'. Don’t repeat 'she'."
      },

      // 6: correct = B
      { s1:"The shoes are uncomfortable.", s2:"I wore them on Monday.",
        options:[
          "The shoes which I wore them on Monday are uncomfortable.",
          "The shoes which I wore on Monday are uncomfortable.",
          "The shoes who I wore on Monday are uncomfortable."
        ],
        correctIndex:1, explanation:"Shoes = things → 'which'. Don’t repeat 'them'."
      },

      // 7: correct = A
      { s1:"We thanked the coach.", s2:"He stayed after training to help us.",
        options:[
          "We thanked the coach who stayed after training to help us.",
          "We thanked the coach which stayed after training to help us.",
          "We thanked the coach who he stayed after training to help us."
        ],
        correctIndex:0, explanation:"Coach = person → 'who'. Don’t repeat 'he'."
      },

      // 8: correct = C
      { s1:"The documentary was amazing.", s2:"We watched it in the lesson.",
        options:[
          "The documentary which we watched it in the lesson was amazing.",
          "The documentary who we watched in the lesson was amazing.",
          "The documentary which we watched in the lesson was amazing."
        ],
        correctIndex:2, explanation:"Documentary = thing → 'which'. Don’t repeat 'it'."
      },

      // 9: correct = B
      { s1:"This is the friend.", s2:"I told you about her yesterday.",
        options:[
          "This is the friend who I told you about her yesterday.",
          "This is the friend who I told you about yesterday.",
          "This is the friend which I told you about her yesterday."
        ],
        correctIndex:1, explanation:"Friend = person → 'who'. Don’t repeat 'her'."
      },

      // 10: correct = A
      { s1:"The street is noisy at night.", s2:"My grandparents live on it.",
        options:[
          "The street which my grandparents live on is noisy at night.",
          "The street who my grandparents live on is noisy at night.",
          "The street which my grandparents live on it is noisy at night."
        ],
        correctIndex:0, explanation:"Street = place/thing → 'which'. Don’t repeat 'it'."
      },

      // 11: correct = C
      { s1:"I know a driver.", s2:"He never uses his phone while driving.",
        options:[
          "I know a driver which never uses his phone while driving.",
          "I know a driver who he never uses his phone while driving.",
          "I know a driver who never uses his phone while driving."
        ],
        correctIndex:2, explanation:"Driver = person → 'who'. Don’t repeat 'he'."
      },

      // 12: correct = B
      { s1:"The app is very useful.", s2:"It reminds me to drink water.",
        options:[
          "The app which it reminds me to drink water is very useful.",
          "The app which reminds me to drink water is very useful.",
          "The app who reminds me to drink water is very useful."
        ],
        correctIndex:1, explanation:"App = thing → 'which'. Don’t repeat 'it'."
      },

      // 13: correct = A
      { s1:"That’s the manager.", s2:"Everyone trusts him.",
        options:[
          "That’s the manager who everyone trusts.",
          "That’s the manager who everyone trusts him.",
          "That’s the manager which everyone trusts him."
        ],
        correctIndex:0, explanation:"Manager = person → 'who'. Don’t repeat 'him'."
      },

      // 14: correct = C
      { s1:"The jacket is too small.", s2:"I ordered it online.",
        options:[
          "The jacket who I ordered online is too small.",
          "The jacket which I ordered it online is too small.",
          "The jacket which I ordered online is too small."
        ],
        correctIndex:2, explanation:"Jacket = thing → 'which'. Don’t repeat 'it'."
      },

      // 15: correct = B
      { s1:"I saw a woman.", s2:"She was looking for her child.",
        options:[
          "I saw a woman who she was looking for her child.",
          "I saw a woman who was looking for her child.",
          "I saw a woman which was looking for her child."
        ],
        correctIndex:1, explanation:"Woman = person → 'who'. Don’t repeat 'she'."
      },

      // 16: correct = A
      { s1:"The room was too cold.", s2:"We had the meeting there.",
        options:[
          "The room which we had the meeting in was too cold.",
          "The room which we had the meeting there was too cold.",
          "The room who we had the meeting there was too cold."
        ],
        correctIndex:0, explanation:"Room = place/thing → 'which'. Better: 'the room which we had the meeting in'."
      },

      // 17: correct = C
      { s1:"He’s the scientist.", s2:"He discovered a new medicine.",
        options:[
          "He’s the scientist which discovered a new medicine.",
          "He’s the scientist who he discovered a new medicine.",
          "He’s the scientist who discovered a new medicine."
        ],
        correctIndex:2, explanation:"Scientist = person → 'who'. Don’t repeat 'he'."
      },

      // 18: correct = B
      { s1:"The photo looks great.", s2:"You took it during the trip.",
        options:[
          "The photo which you took it during the trip looks great.",
          "The photo which you took during the trip looks great.",
          "The photo who you took during the trip looks great."
        ],
        correctIndex:1, explanation:"Photo = thing → 'which'. Don’t repeat 'it'."
      },

      // 19: correct = A
      { s1:"That’s the student.", s2:"The teacher chose her for the team.",
        options:[
          "That’s the student who the teacher chose for the team.",
          "That’s the student who the teacher chose her for the team.",
          "That’s the student which the teacher chose her for the team."
        ],
        correctIndex:0, explanation:"Student = person → 'who'. Don’t repeat 'her'."
      },

      // 20: correct = C
      { s1:"The chair is still wet.", s2:"Someone cleaned it.",
        options:[
          "The chair which someone cleaned it is still wet.",
          "The chair who someone cleaned is still wet.",
          "The chair which someone cleaned is still wet."
        ],
        correctIndex:2, explanation:"Chair = thing → 'which'. Don’t repeat 'it'."
      }
    ];

    // ----------------------------
    // STATE
    // ----------------------------
    let currentQuestion = 0;
    let score = 0;

    const qState = questions.map(() => ({ selectedIndex: null, expired: false, timeSpent: 0 }));

    let timerInterval = null;
    let timeLeft = TIME_PER_QUESTION;

    let violations = 0;
    let lastViolationAt = 0;
    const violationLog = [];

    let student = { name: "", group: "", level: "" };
    let testStarted = false;
    let testFinished = false;

    // ----------------------------
    // DOM
    // ----------------------------
    const questionContainer = document.getElementById("question-container");
    const feedback = document.getElementById("feedback");
    const scoreDisplay = document.getElementById("score");
    const progressDisplay = document.getElementById("progress");
    const currentQuestionNum = document.getElementById("current-question-num");
    const progressPercent = document.getElementById("progress-percent");
    const progressFill = document.getElementById("progress-fill");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const subtitle = document.getElementById("subtitle");
    const statsBar = document.getElementById("stats-bar");
    const progressWrap = document.getElementById("progress-wrap");
    const navButtons = document.getElementById("nav-buttons");
    const timerEl = document.getElementById("timer");
    const violationsEl = document.getElementById("violations");

    const violationOverlay = document.getElementById("violationOverlay");
    const violationReasonEl = document.getElementById("violationReason");
    const violationCountText = document.getElementById("violationCountText");
    const violationMaxText = document.getElementById("violationMaxText");
    const violationOkBtn = document.getElementById("violationOkBtn");
    const violationNote = document.getElementById("violationNote");
    violationMaxText.textContent = String(MAX_VIOLATIONS);

    // ----------------------------
    // HELPERS
    // ----------------------------
    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setTestUIVisible(isVisible) {
      statsBar.style.display = isVisible ? "flex" : "none";
      progressWrap.style.display = isVisible ? "block" : "none";
      navButtons.style.display = isVisible ? "flex" : "none";
    }

    function updateScoreDisplay() {
      scoreDisplay.textContent = `${score}/${questions.length}`;
    }

    function updateProgressDisplay() {
      const progress = currentQuestion + 1;
      const percent = Math.round((progress / questions.length) * 100);
      progressDisplay.textContent = `${progress}/${questions.length}`;
      currentQuestionNum.textContent = progress;
      progressPercent.textContent = `${percent}%`;
      progressFill.style.width = `${percent}%`;
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
    }

    function updateTimerUI() {
      timerEl.textContent = `${timeLeft}s`;
      if (timeLeft <= 5) timerEl.parentElement.classList.add("ring-2", "ring-white/60");
      else timerEl.parentElement.classList.remove("ring-2", "ring-white/60");
    }

    function startTimerIfNeeded() {
      stopTimer();

      if (!testStarted || testFinished) return;

      const st = qState[currentQuestion];
      if (st.selectedIndex !== null || st.expired) {
        timeLeft = Math.max(0, TIME_PER_QUESTION - st.timeSpent);
        if (st.expired) timeLeft = 0;
        updateTimerUI();
        return;
      }

      timeLeft = Math.max(0, TIME_PER_QUESTION - st.timeSpent);
      updateTimerUI();

      timerInterval = setInterval(() => {
        if (violationOverlay.classList.contains("hidden") === false) return;
        if (!testStarted || testFinished) return;

        st.timeSpent += 1;
        timeLeft = Math.max(0, TIME_PER_QUESTION - st.timeSpent);
        updateTimerUI();

        if (timeLeft <= 0) {
          stopTimer();
          handleTimeout();
        }
      }, 1000);
    }

    function handleTimeout() {
      const st = qState[currentQuestion];
      if (st.selectedIndex !== null || st.expired) return;

      st.expired = true;
      renderQuestion();
      showFeedback(false, "Time is up! Move to the next question.");
      nextBtn.disabled = false;
    }

    function updateViolationsUI() {
      violationsEl.textContent = String(violations);
    }

    // ----------------------------
    // VIOLATIONS
    // ----------------------------
    function showViolationOverlay(reason) {
      violationReasonEl.textContent = reason;
      violationCountText.textContent = String(violations);

      if (violations >= MAX_VIOLATIONS) {
        violationNote.textContent = "Test will be submitted now.";
        violationOkBtn.textContent = "Submit";
      } else {
        violationNote.textContent = "Please stay on the test page.";
        violationOkBtn.textContent = "I Understand";
      }

      violationOverlay.classList.remove("hidden");
      violationOverlay.classList.add("flex");
      stopTimer();
    }

    function hideViolationOverlay() {
      violationOverlay.classList.add("hidden");
      violationOverlay.classList.remove("flex");
      startTimerIfNeeded();
    }

    function registerViolation(reason) {
      if (!testStarted || testFinished) return;

      const now = Date.now();
      if (now - lastViolationAt < VIOLATION_COOLDOWN_MS) return;
      lastViolationAt = now;

      violations += 1;
      violationLog.push({ reason, ts: new Date().toISOString() });
      updateViolationsUI();

      showViolationOverlay(reason);

      if (violations >= MAX_VIOLATIONS) {
        setTimeout(() => {
          if (!testFinished) endTest(true);
        }, 700);
      }
    }

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) registerViolation("You switched the screen / left the tab.");
    });
    window.addEventListener("blur", () => {
      registerViolation("You left the test window (focus lost).");
    });
    window.addEventListener("pagehide", () => {
      registerViolation("You left the page.");
    });

    violationOkBtn.addEventListener("click", () => {
      if (violations >= MAX_VIOLATIONS) endTest(true);
      else hideViolationOverlay();
    });

    // ----------------------------
    // LOGIN
    // ----------------------------
    function renderLogin() {
      testStarted = false;
      testFinished = false;
      stopTimer();

      setTestUIVisible(false);
      subtitle.textContent = "Login to start the test";
      feedback.classList.add("hidden");
      timerEl.textContent = "--";

      violations = 0;
      violationLog.length = 0;
      updateViolationsUI();

      // reset state (in case new student)
      currentQuestion = 0;
      score = 0;
      for (const st of qState) {
        st.selectedIndex = null;
        st.expired = false;
        st.timeSpent = 0;
      }
      updateScoreDisplay();

      questionContainer.innerHTML = `
        <div class="max-w-xl mx-auto fade-in">
          <div class="bg-blue-50 border border-blue-100 rounded-2xl p-6">
            <div class="flex items-center mb-4">
              <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                <i class="fas fa-user text-blue-600 text-xl"></i>
              </div>
              <div>
                <h2 class="text-2xl font-bold text-gray-800">Student Login</h2>
                <p class="text-gray-600">Enter your details to begin.</p>
              </div>
            </div>

            <div class="space-y-4 mt-6">
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Student Name</label>
                <input id="studentName" type="text" placeholder="e.g., Ali Karimov"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-300" />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Group</label>
                <input id="studentGroup" type="text" placeholder="e.g., Group A / IELTS_AGE 7PM"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-300" />
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">Level</label>
                <select id="studentLevel"
                  class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-300 bg-white">
                  <option value="">Select level</option>
                  <option>Beginner</option>
                  <option>Elementary</option>
                  <option>Pre-Intermediate</option>
                  <option>Intermediate</option>
                  <option>Upper-Intermediate</option>
                  <option>IELTS / Advanced</option>
                </select>
              </div>

              <div id="loginError" class="hidden p-3 rounded-xl border bg-red-50 border-red-200 text-red-700 text-sm"></div>

              <button id="startBtn"
                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold px-6 py-3 rounded-xl transition duration-200 flex items-center justify-center">
                Start Test <i class="fas fa-play ml-2"></i>
              </button>
            </div>
          </div>
        </div>
      `;

      const startBtn = document.getElementById("startBtn");
      const nameEl = document.getElementById("studentName");
      const groupEl = document.getElementById("studentGroup");
      const levelEl = document.getElementById("studentLevel");
      const errEl = document.getElementById("loginError");

      [nameEl, groupEl, levelEl].forEach(el => {
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter") startBtn.click();
        });
      });

      startBtn.addEventListener("click", () => {
        const name = (nameEl.value || "").trim();
        const group = (groupEl.value || "").trim();
        const level = (levelEl.value || "").trim();

        if (!name || !group || !level) {
          errEl.textContent = "Please fill in Student Name, Group, and Level.";
          errEl.classList.remove("hidden");
          return;
        }
        errEl.classList.add("hidden");

        student = { name, group, level };
        subtitle.textContent = `Student: ${student.name} • ${student.group} • ${student.level}`;

        renderStartAnimation();
      });
    }

    // ----------------------------
    // START ANIMATION
    // ----------------------------
    function renderStartAnimation() {
      setTestUIVisible(false);
      feedback.classList.add("hidden");

      questionContainer.innerHTML = `
        <div class="max-w-xl mx-auto fade-in">
          <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-2xl p-6 shadow-sm">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm opacity-90">Welcome,</div>
                <div class="text-2xl font-bold">${escapeHtml(student.name)}</div>
              </div>
              <div class="w-12 h-12 rounded-full bg-white/15 flex items-center justify-center">
                <i class="fas fa-bolt text-white text-xl"></i>
              </div>
            </div>

            <div class="mt-5">
              <div class="text-lg font-semibold">Get ready…</div>
              <div class="text-white/90 mt-1">Each question has <span class="font-bold">${TIME_PER_QUESTION}s</span>.</div>
            </div>

            <div class="mt-6">
              <div class="ready-bar">
                <div class="ready-fill" id="readyFill"></div>
              </div>
              <div class="flex justify-between text-xs mt-2 text-white/80">
                <span>${escapeHtml(student.group)} • ${escapeHtml(student.level)}</span>
                <span>Starting…</span>
              </div>
            </div>
          </div>

          <div class="mt-4 bg-blue-50 border border-blue-100 rounded-2xl p-4">
            <div class="flex items-start gap-3">
              <div class="w-9 h-9 rounded-full bg-blue-100 flex items-center justify-center shrink-0">
                <i class="fas fa-shield-halved text-blue-600"></i>
              </div>
              <div class="text-gray-700">
                <div class="font-semibold">Rules</div>
                <div class="text-sm leading-relaxed">
                  Don’t switch tabs/apps. After <b>${MAX_VIOLATIONS}</b> violations, the test is submitted.
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      const fill = document.getElementById("readyFill");
      requestAnimationFrame(() => { fill.style.width = "100%"; });

      setTimeout(() => {
        testStarted = true;
        setTestUIVisible(true);
        updateScoreDisplay();
        updateProgressDisplay();
        renderQuestion();
      }, 3300);
    }

    // ----------------------------
    // RENDER QUESTION
    // ----------------------------
    function renderQuestion() {
      const q = questions[currentQuestion];
      const st = qState[currentQuestion];
      const answered = st.selectedIndex !== null || st.expired;

      let html = `
        <div class="mb-6 fade-in">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center">
              <div class="bg-blue-100 text-blue-800 font-semibold rounded-full w-8 h-8 flex items-center justify-center mr-3">
                ${currentQuestion + 1}
              </div>
              <h2 class="text-xl font-bold text-gray-800">Combine the Sentences</h2>
            </div>
            <div class="text-sm text-gray-500">
              Time: <span class="font-semibold">${Math.max(0, TIME_PER_QUESTION - st.timeSpent)}s</span>
            </div>
          </div>

          <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 mb-6">
            <p class="text-gray-800 text-lg leading-relaxed">
              <span class="font-semibold">1)</span> ${q.s1}<br/>
              <span class="font-semibold">2)</span> ${q.s2}
            </p>
          </div>

          <div class="space-y-4 mb-2" id="options">
      `;

      q.options.forEach((text, idx) => {
        const isCorrect = idx === q.correctIndex;
        const isUser = st.selectedIndex === idx;

        let optionClass = "p-4 border-2 rounded-xl transition duration-200 w-full text-left ";
        if (!answered) {
          optionClass += "bg-white border-gray-300 hover:border-blue-400 hover:bg-blue-50 active:scale-[0.99]";
        } else {
          if (isCorrect) optionClass += "option-correct border-green-400 ";
          else if (isUser && !isCorrect) optionClass += "option-incorrect border-red-300 ";
          else optionClass += "bg-gray-50 border-gray-200 opacity-80 ";
        }

        const letter = String.fromCharCode(65 + idx);
        html += `
          <button type="button" class="${optionClass}" data-option-index="${idx}" ${answered ? "disabled" : ""}>
            <div class="flex items-start">
              <div class="shrink-0 w-9 h-9 bg-gray-100 rounded-full flex items-center justify-center mr-3 font-bold">
                ${letter}
              </div>
              <div class="font-medium text-gray-900 leading-relaxed">${text}</div>
            </div>
          </button>
        `;
      });

      html += `</div>`;

      if (st.expired) {
        html += `
          <div class="mt-4 p-4 rounded-xl border bg-yellow-50 border-yellow-200">
            <div class="flex items-center gap-2 text-yellow-800 font-semibold">
              <i class="fas fa-clock"></i> Time’s up for this question.
            </div>
            <div class="text-yellow-700 text-sm mt-1">You didn’t answer within ${TIME_PER_QUESTION} seconds.</div>
          </div>
        `;
      }

      if (answered) {
        html += `
          <div class="mt-6 p-4 bg-gray-50 rounded-lg border">
            <div class="flex items-center mb-2">
              <i class="fas fa-info-circle text-blue-500 mr-2"></i>
              <h3 class="font-semibold text-gray-800">Explanation</h3>
            </div>
            <p class="text-gray-700 leading-relaxed">${q.explanation}</p>
          </div>
        `;
      }

      html += `</div>`;
      questionContainer.innerHTML = html;

      document.getElementById("options").addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-option-index]");
        if (!btn) return;
        selectOption(Number(btn.dataset.optionIndex));
      });

      prevBtn.disabled = currentQuestion === 0;
      nextBtn.textContent = currentQuestion === questions.length - 1 ? "Submit Test" : "Next Question";
      nextBtn.disabled = !(st.selectedIndex !== null || st.expired);

      updateProgressDisplay();
      startTimerIfNeeded();
    }

    function selectOption(idx) {
      const st = qState[currentQuestion];
      if (st.selectedIndex !== null || st.expired) return;

      st.selectedIndex = idx;
      stopTimer();

      const q = questions[currentQuestion];
      const isCorrect = idx === q.correctIndex;
      if (isCorrect) score++;

      updateScoreDisplay();
      renderQuestion();
      showFeedback(isCorrect, q.explanation);
    }

    function showFeedback(isCorrect, explanation) {
      feedback.classList.remove("hidden");

      if (isCorrect) {
        feedback.className = "mt-6 p-4 rounded-lg border bg-green-50 border-green-200";
        feedback.innerHTML = `
          <div class="flex items-center">
            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-check text-green-600"></i>
            </div>
            <div>
              <h3 class="font-bold text-green-800">Correct!</h3>
              <p class="text-green-700 leading-relaxed">${explanation}</p>
            </div>
          </div>
        `;
      } else {
        feedback.className = "mt-6 p-4 rounded-lg border bg-red-50 border-red-200";
        feedback.innerHTML = `
          <div class="flex items-center">
            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
              <i class="fas fa-times text-red-600"></i>
            </div>
            <div>
              <h3 class="font-bold text-red-800">Incorrect</h3>
              <p class="text-red-700 leading-relaxed">${explanation}</p>
            </div>
          </div>
        `;
      }
      feedback.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    prevBtn.addEventListener("click", () => {
      if (currentQuestion > 0) {
        currentQuestion--;
        feedback.classList.add("hidden");
        renderQuestion();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (!testStarted || testFinished) return;

      if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        feedback.classList.add("hidden");
        renderQuestion();
      } else {
        endTest(false);
      }
    });

    // ----------------------------
    // FINISH PAGE (rewarding)
    // ----------------------------
    function getPerformance(score, total) {
      const pct = Math.round((score / total) * 100);
      if (pct >= 90) return { title: "Legendary Grammar Master", icon: "fa-crown" };
      if (pct >= 75) return { title: "Strong Performer", icon: "fa-medal" };
      if (pct >= 60) return { title: "Solid Progress", icon: "fa-star" };
      if (pct >= 45) return { title: "Good Effort", icon: "fa-thumbs-up" };
      return { title: "Keep Going — You’ll Improve!", icon: "fa-seedling" };
    }

    function getPraiseMessage(score) {
      if (score >= 18) return "Excellent! You understand relative clauses very well!";
      if (score >= 15) return "Very good! You know most of the rules.";
      if (score >= 12) return "Good job! You understand the basics.";
      if (score >= 9) return "Not bad! Review the explanations to improve.";
      return "Keep practicing! Review WHO/WHICH rules and pronoun repetition mistakes.";
    }

    function spawnConfetti() {
      const wrap = document.querySelector(".confetti-wrap");
      if (!wrap) return;

      const pieces = 36;
      for (let i = 0; i < pieces; i++) {
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = Math.random() * 100 + "%";
        c.style.animationDelay = (Math.random() * 0.35) + "s";
        const w = 8 + Math.random() * 10;
        const h = 10 + Math.random() * 14;
        c.style.width = w + "px";
        c.style.height = h + "px";
        const hue = Math.floor(Math.random() * 360);
        c.style.background = `hsl(${hue} 85% 60%)`;
        wrap.appendChild(c);
        setTimeout(() => c.remove(), 3500);
      }
    }

    function countExpired() {
      return qState.filter(q => q.expired).length;
    }

    async function endTest(forced) {
      if (testFinished) return;
      testFinished = true;
      stopTimer();
      hideViolationOverlay();

      const total = questions.length;
      const percentage = Math.round((score / total) * 100);
      const perf = getPerformance(score, total);

      const forcedNote = forced
        ? `<div class="mt-4 bg-red-50 border border-red-200 rounded-xl p-4 text-left">
             <div class="font-semibold text-red-800 flex items-center gap-2">
               <i class="fas fa-shield-halved"></i> Submitted due to violations
             </div>
             <div class="text-sm text-red-700 mt-1">
               Violations: <b>${violations}</b> / ${MAX_VIOLATIONS}
             </div>
           </div>`
        : "";

      questionContainer.innerHTML = `
        <div class="confetti-wrap text-center py-8 fade-in">
          <div class="mb-6">
            <div class="w-20 h-20 mx-auto bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mb-4 badge-pop">
              <i class="fas ${perf.icon} text-white text-3xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Well done, ${escapeHtml(student.name)}!</h2>
            <p class="text-gray-600">${escapeHtml(perf.title)}</p>
          </div>

          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-2xl border border-blue-100 max-w-2xl mx-auto mb-6">
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 text-left">
              <div class="bg-white rounded-xl border p-4">
                <div class="text-sm text-gray-500">Group</div>
                <div class="font-semibold text-gray-800">${escapeHtml(student.group)}</div>
              </div>
              <div class="bg-white rounded-xl border p-4">
                <div class="text-sm text-gray-500">Level</div>
                <div class="font-semibold text-gray-800">${escapeHtml(student.level)}</div>
              </div>
              <div class="bg-white rounded-xl border p-4">
                <div class="text-sm text-gray-500">Violations</div>
                <div class="font-semibold text-gray-800">${violations}</div>
              </div>
              <div class="bg-white rounded-xl border p-4">
                <div class="text-sm text-gray-500">Timeouts</div>
                <div class="font-semibold text-gray-800">${countExpired()}</div>
              </div>
            </div>

            <div class="mt-6">
              <div class="text-5xl font-bold text-blue-600 mb-2">${percentage}%</div>
              <div class="text-xl font-semibold text-gray-800 mb-1">${score}/${total} Correct</div>
              <div class="text-lg text-blue-500 font-medium">${getPraiseMessage(score)}</div>
            </div>

            ${forcedNote}
          </div>

          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <button onclick="location.reload()"
              class="bg-blue-500 hover:bg-blue-600 text-white font-medium px-6 py-3 rounded-lg transition duration-200 flex items-center justify-center">
              <i class="fas fa-sync-alt mr-2"></i> Restart Test
            </button>

            <button id="backToLogin"
              class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium px-6 py-3 rounded-lg transition duration-200 flex items-center justify-center">
              <i class="fas fa-user mr-2"></i> New Student
            </button>
          </div>
        </div>
      `;

      prevBtn.style.display = "none";
      nextBtn.style.display = "none";
      feedback.classList.add("hidden");

      if (!forced) spawnConfetti();

      document.getElementById("backToLogin").addEventListener("click", () => {
        prevBtn.style.display = "";
        nextBtn.style.display = "";
        renderLogin();
      });
    }

    // ----------------------------
    // INIT
    // ----------------------------
    updateScoreDisplay();
    updateViolationsUI();
    setTestUIVisible(false);
    renderLogin();
  </script>
</body>
</html>
